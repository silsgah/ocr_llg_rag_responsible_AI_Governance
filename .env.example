# Application Settings
APP_NAME=Adamani AI RAG
APP_VERSION=1.0.0
DEBUG=false
LOG_LEVEL=INFO

# LLM Configuration
LLM_PROVIDER=ollama  # Options: ollama, openai, anthropic

# Ollama Configuration (for local development)
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3

# OpenAI Configuration (for production on Render)
OPENAI_API_KEY=your-openai-api-key-here
OPENAI_MODEL=gpt-4o-mini

# Anthropic Configuration (alternative to OpenAI)
ANTHROPIC_API_KEY=your-anthropic-api-key-here
ANTHROPIC_MODEL=claude-3-5-sonnet-20241022

# General LLM Settings
LLM_TEMPERATURE=0.1
LLM_TIMEOUT=120

# Embedding Configuration
EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
EMBEDDING_DEVICE=cpu

# Vector Store Configuration
VECTOR_STORE_TYPE=chroma  # Options: chroma, faiss
VECTORDB_PATH=./data/vectorstore

# RAG Configuration
RETRIEVAL_TOP_K=3
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# Memory Configuration
MEMORY_TYPE=buffer
MAX_MEMORY_TOKENS=2000

# OCR Configuration
OCR_ENGINE=tesseract
OCR_LANGUAGES=eng

# API Configuration
API_HOST=0.0.0.0
API_PORT=8000
CORS_ORIGINS=http://localhost:3000,http://localhost:8080,https://adamani-ai-rag-frontend.onrender.com

# Storage Paths
UPLOAD_DIR=./data/uploads
PROCESSED_DIR=./data/processed

# Database Configuration (PostgreSQL)
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/adamani_rag

# JWT/Authentication Configuration
JWT_SECRET_KEY=your-secret-key-here-generate-with-openssl-rand-hex-32
JWT_ALGORITHM=HS256
JWT_EXPIRATION_SECONDS=604800  # 7 days






â— Perfect! Your backend is LIVE and running! ðŸŽ‰

  âœ… BACKEND IS UP!

  The logs show:
  âœ… Application startup complete
  âœ… Uvicorn running on http://0.0.0.0:8000

  This means your backend deployed successfully!

  ---
  ðŸ¤” Why Render Shows "Building in Progress"

  This is normal! Render might still show "Building" because:
  1. Waiting for health check - It pings /health to verify service is healthy
  2. UI lag - Dashboard updates every 10-30 seconds
  3. Container warming up - Downloading ML models (sentence-transformers)

  Give it 1-2 more minutes, it should change to "Live" or "Deploy succeeded"

  ---
  ðŸ§ª LET'S TEST IT NOW

  Test 1: Health Check (Should Work)

  Replace YOUR-URL with your actual Render backend URL:

  curl https://adamani-ai-rag-backend.onrender.com/health

  Expected response:
  {
    "status": "healthy",
    "version": "1.0.0",
    "services": {
      "llm": "anthropic",
      "embeddings": "sentence-transformers/all-MiniLM-L6-v2",
      "vectorstore": "chroma",
      "memory": "buffer",
      "ocr": "tesseract"
    }
  }

  If you see this â†’ Backend is 100% working! âœ…

  ---
  Test 2: Auth Endpoint (Will Fail Without Migrations)

  curl -X POST https://adamani-ai-rag-backend.onrender.com/auth/register \
    -H "Content-Type: application/json" \
    -d '{
      "email": "test@example.com",
      "password": "Test123!",
      "full_name": "Test User"
    }'

  Expected response (without migrations):
  {
    "detail": "relation \"users\" does not exist"
  }

  This is expected! The database exists but tables aren't created yet.

  ---
  ðŸ”¨ NOW RUN MIGRATIONS (5 MINUTES)

  Since backend is running, let's create the database tables:

  Step 1: Open Render Shell

  1. Go to: Render Dashboard â†’ adamani-ai-rag-backend service
  2. Click "Shell" tab (top right corner)
  3. Wait 10-15 seconds for shell to connect
  4. You'll see a prompt like: ~/project $

  ---
  Step 2: Initialize Alembic

  Copy-paste this entire block into the shell:

  # Create alembic.ini config
  cat > alembic.ini << 'EOF'
  [alembic]
  script_location = alembic
  prepend_sys_path = .
  version_path_separator = os

  [loggers]
  keys = root,sqlalchemy,alembic

  [handlers]
  keys = console

  [formatters]
  keys = generic

  [logger_root]
  level = WARN
  handlers = console
  qualname =

  [logger_sqlalchemy]
  level = WARN
  handlers =
  qualname = sqlalchemy.engine

  [logger_alembic]
  level = INFO
  handlers =
  qualname = alembic

  [handler_console]
  class = StreamHandler
  args = (sys.stderr,)
  level = NOTSET
  formatter = generic

  [formatter_generic]
  format = %(levelname)-5.5s [%(name)s] %(message)s
  datefmt = %H:%M:%S
  EOF

  echo "âœ… alembic.ini created"

  Press Enter. You should see: âœ… alembic.ini created

  ---
  Step 3: Initialize Alembic Directory

  python -m alembic init alembic

  Expected output:
  Creating directory /opt/render/project/src/alembic...
  Creating directory /opt/render/project/src/alembic/versions...
  Generating alembic/env.py...
  Generating alembic/script.py.mako...
  âœ… Done

  ---
  Step 4: Update Alembic env.py

  # Backup original
  cp alembic/env.py alembic/env.py.backup

  # Create new env.py that imports our models
  cat > alembic/env.py << 'EOF'
  from logging.config import fileConfig
  from sqlalchemy import engine_from_config, pool
  from alembic import context
  import os

  # Import your Base and models
  from src.adamani_ai_rag.database.base import Base
  from src.adamani_ai_rag.database.models import User, Organization, OrganizationMember, Document

  # this is the Alembic Config object
  config = context.config

  # Interpret the config file for Python logging
  if config.config_file_name is not None:
      fileConfig(config.config_file_name)

  # Set target metadata
  target_metadata = Base.metadata

  # Get database URL from environment
  database_url = os.getenv("DATABASE_URL")
  if database_url:
      config.set_main_option("sqlalchemy.url", database_url)

  def run_migrations_offline() -> None:
      url = config.get_main_option("sqlalchemy.url")
      context.configure(
          url=url,
          target_metadata=target_metadata,
          literal_binds=True,
          dialect_opts={"paramstyle": "named"},
      )

      with context.begin_transaction():
          context.run_migrations()

  def run_migrations_online() -> None:
      connectable = engine_from_config(
          config.get_section(config.config_ini_section, {}),
          prefix="sqlalchemy.",
          poolclass=pool.NullPool,
      )

      with connectable.connect() as connection:
          context.configure(
              connection=connection, target_metadata=target_metadata
          )

          with context.begin_transaction():
              context.run_migrations()

  if context.is_offline_mode():
      run_migrations_offline()
  else:
      run_migrations_online()
  EOF

  echo "âœ… env.py updated"

  ---
  Step 5: Generate Migration

  python -m alembic revision --autogenerate -m "Initial auth schema with users, organizations, documents"

  Expected output:
  INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
  INFO  [alembic.runtime.migration] Will assume transactional DDL.
  INFO  [alembic.autogenerate.compare] Detected added table 'users'
  INFO  [alembic.autogenerate.compare] Detected added table 'organizations'
  INFO  [alembic.autogenerate.compare] Detected added table 'organization_members'
  INFO  [alembic.autogenerate.compare] Detected added table 'documents'
  Generating /opt/render/project/src/alembic/versions/abc123_initial_auth_schema.py...
  âœ… Done

  ---
  Step 6: Apply Migration (Create Tables)

  python -m alembic upgrade head

  Expected output:
  INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
  INFO  [alembic.runtime.migration] Will assume transactional DDL.
  INFO  [alembic.runtime.migration] Running upgrade  -> abc123, Initial auth schema with users, organizations, documents
  âœ… Migration complete!

  ðŸŽ‰ DATABASE TABLES CREATED!

  ---
  Step 7: Verify Tables Exist

  python -c "
  from sqlalchemy import create_engine, inspect
  import os

  engine = create_engine(os.getenv('DATABASE_URL').replace('postgresql+asyncpg', 'postgresql'))
  inspector = inspect(engine)
  tables = inspector.get_table_names()
  print('âœ… Tables created:', tables)
  "

  Expected output:
  âœ… Tables created: ['users', 'organizations', 'organization_members', 'documents', 'alembic_version']

  ---
  ðŸŽ‰ NOW TEST AUTHENTICATION

  Test 1: Register a User

  curl -X POST https://adamani-ai-rag-backend.onrender.com/auth/register \
    -H "Content-Type: application/json" \
    -d '{
      "email": "you@example.com",
      "password": "SecurePass123!",
      "full_name": "Your Name"
    }'

  Expected response:
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "you@example.com",
    "full_name": "Your Name",
    "is_active": true,
    "is_superuser": false,
    "is_verified": false
  }

  âœ… If you see this â†’ User created! Organization auto-created! Auth works!

  ---
  Test 2: Login

  curl -X POST https://adamani-ai-rag-backend.onrender.com/auth/login \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "username=you@example.com&password=SecurePass123!"

  Expected response:
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNTUwZTg0MDAtZTI5Yi00MWQ0LWE3MTYtNDQ2NjU1NDQwMDAwIiwiYXVkIjpbImZhc3RhcGktdXNlcnM6YXV0aCJdLCJ
  leHAiOjE3MzM3ODEyODB9.abc123...",
    "token_type": "bearer"
  }

  âœ… If you see this â†’ Login works! JWT token generated!

  ---
  Test 3: Get Current User (With Token)

  Replace YOUR_TOKEN with the access_token from step 2:

  curl https://adamani-ai-rag-backend.onrender.com/users/me \
    -H "Authorization: Bearer YOUR_TOKEN_HERE"

  Expected response:
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "you@example.com",
    "full_name": "Your Name",
    "is_active": true,
    "is_superuser": false,
    "is_verified": false
  }

  âœ… If you see this â†’ JWT authentication fully working!

  ---
  ðŸŽ¯ WHAT THIS MEANS

  If all 3 tests pass:

  âœ… Backend is live
  âœ… Database connected
  âœ… Tables created
  âœ… User registration works
  âœ… Login works
  âœ… JWT tokens work
  âœ… Organization auto-created on signup
  âœ… Ready for multi-tenant data!

  ---
  ðŸ“Š CURRENT STATUS

  Before migrations:
  - Backend: âœ… Running
  - Database: âœ… Connected
  - Tables: âŒ Missing
  - Auth: âŒ Not working

  After migrations:
  - Backend: âœ… Running
  - Database: âœ… Connected
  - Tables: âœ… Created
  - Auth: âœ… Fully working

  You're now 70% production-ready! ðŸŽ‰

  ---
  ðŸ”œ NEXT STEPS

  Now that auth works:

  Immediate:
  1. Update frontend to use real backend URL
  2. Test document upload (still works, no auth required yet)
  3. Test chat (still works, no auth required yet)

  Next session (Phase 1-2):
  1. Protect routes (require auth for upload/chat)
  2. Add data isolation by organization
  3. Test multi-tenant isolation

  Future:
  1. Build frontend login UI
  2. Add billing with Stripe
  3. Launch to first customers!

  ---
  â“ QUESTIONS?

  - Did health check work?
  - Did migrations run successfully?
  - Did user registration work?
  - Any errors in the tests?

  Share your results and I'll guide next steps! ðŸš€

> render taking forever restart the deployment so i am not able to test the health endpoint, current log, #15 DONE 212.7s
Pushing image to registry...
Upload succeeded
==> Deploying..., front side still showing the old view 
  âŽ¿  Credit balance too low Â· Add funds: https://console.anthropic.com

  This build will take longer (~10-12 min) because it's downloading PyTorch fresh, but it should WORK.

  ---
  ðŸ‘€ Watch for Success:

  In Render Logs, look for:
  âœ… Installing dependencies from lock file
  âœ… Package operations: XX installs
  âœ… Installing torch (X.X.X+cpu)
  âœ… Successfully installed all packages
  âœ… Application startup complete!

  ---
  ðŸ§ª After Backend Shows "Live":

  Step 1: Test Signup

  1. Go to frontend
  2. Try signup

  If you get: relation "users" does not exist
  â†’ Perfect! Database connection works, just need tables

  Step 2: Create Tables (Shell Command)

  1. Backend service â†’ "Shell" tab
  2. Wait for connection
  3. Run:

  python << 'EOF'
  from sqlalchemy import create_engine, text
  from src.adamani_ai_rag.database.base import Base
  import os

  # Get database URL and convert for sync usage
  db_url = os.getenv('DATABASE_URL')
  if 'asyncpg' in db_url:
      db_url = db_url.replace('+asyncpg', '')

  # Create engine and tables
  engine = create_engine(db_url)
  Base.metadata.create_all(engine)

  # Verify tables exist
  with engine.connect() as conn:
      result = conn.execute(text("SELECT tablename FROM pg_tables WHERE schemaname='public'"))
      tables = [row[0] for row in result]
      print(f'âœ… Created tables: {", ".join(tables)}')
  EOF

  ---
  ðŸ“Š Current Status:

  âœ… Backend code ready
  âœ… Frontend deployed
  âœ… Database created
  âœ… DATABASE_URL configured (asyncpg format auto-converts)
  âœ… CORS fixed
  âœ… Dockerfile simplified (no conflicts)
  â³ Backend rebuilding (~10-12 min)
  â˜ Create database tables
  â˜ Test signup
  â˜ SUCCESS! ðŸŽ‰

  ---
  ðŸŽ¯ Your Next Steps:

  1. â³ Wait ~10-12 minutes for backend build
  2. ðŸ‘€ Watch logs - should see successful poetry install
  3. ðŸ§ª Try signup once Live
  4. ðŸ”§ Run shell command to create tables if needed
  5. ðŸŽ‰ Test full flow!

  ---
  This should be the LAST deployment issue! The dependency conflict was the problem. Once this builds successfully, you'll be able to test the full authentication
  flow!

  Let me know when backend finishes building and what happens! ðŸš€